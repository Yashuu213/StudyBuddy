<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StudyBuddy - AI Learning Companion</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='progress-settings.css') }}">
    <style>
        :root {
            --bg-color: #0f172a;
            --sidebar-bg: rgba(30, 41, 59, 0.7);
            --card-bg: rgba(51, 65, 85, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-color: #38bdf8;
            --accent-hover: #0ea5e9;
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            display: flex;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: var(--card-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            height: 100%;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            border-right: var(--glass-border);
            background: var(--sidebar-bg);
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .nav-links {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .nav-item {
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(56, 189, 248, 0.1);
            color: var(--accent-color);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Breadcrumb */
        .breadcrumb {
            margin-bottom: 2rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .breadcrumb span {
            cursor: pointer;
        }

        .breadcrumb span:hover {
            color: var(--accent-color);
        }

        /* Grid Layout */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .card {
            padding: 1.5rem;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border-color: var(--accent-color);
        }

        .card h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
        }

        .card p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Topic View */
        .topic-container {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: var(--glass-border);
            padding-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.2s;
        }

        .tab.active {
            background: var(--accent-color);
            color: #000;
            font-weight: 600;
        }

        .content-section {
            display: none;
            line-height: 1.8;
            color: var(--text-primary);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* AI Chat */
        .ai-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: var(--accent-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.4);
            transition: transform 0.2s;
            z-index: 100;
        }

        .ai-fab:hover {
            transform: scale(1.1);
        }

        .ai-box {
            position: fixed;
            bottom: 6rem;
            right: 2rem;
            width: 350px;
            height: 500px;
            display: none;
            flex-direction: column;
            z-index: 100;
            overflow: hidden;
        }

        .ai-box.open {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .chat-header {
            padding: 1rem;
            background: rgba(56, 189, 248, 0.1);
            border-bottom: var(--glass-border);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            padding: 0.75rem;
            border-radius: 12px;
            max-width: 85%;
            font-size: 0.9rem;
        }

        .user-msg {
            background: var(--accent-color);
            color: #000;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .ai-msg {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: var(--glass-border);
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.2);
            border: none;
            padding: 0.75rem;
            border-radius: 8px;
            color: white;
            outline: none;
        }

        .send-btn {
            background: var(--accent-color);
            border: none;
            width: 40px;
            border-radius: 8px;
            cursor: pointer;
            color: #000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Quiz Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            opacity: 1;
            pointer-events: all;
        }

        .quiz-modal {
            width: 90%;
            max-width: 600px;
            padding: 2rem;
            max-height: 80vh;
            overflow-y: auto;
        }

        .option-btn {
            display: block;
            width: 100%;
            padding: 1rem;
            margin: 0.5rem 0;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .option-btn.selected {
            border-color: var(--accent-color);
            background: rgba(56, 189, 248, 0.1);
        }

        .option-btn.correct {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
        }

        .option-btn.wrong {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading Spinner */
        .loader {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        .year-tag {
            float: right;
            color: var(--accent-color);
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 4px;
            margin-left: 10px;
            font-size: 0.9em;
        }

        /* Hero Section */
        .hero-section {
            background: linear-gradient(135deg, rgba(56, 189, 248, 0.2) 0%, rgba(59, 130, 246, 0.2) 100%);
            border-radius: 24px;
            padding: 3rem;
            margin-bottom: 3rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .hero-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hero-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin-bottom: 2rem;
        }

        .hero-stats {
            display: flex;
            gap: 2rem;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <nav class="sidebar glass">
        <div class="logo">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 10v6M2 10v6" />
                <path d="M20 2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h15z" />
            </svg>
            StudyBuddy
        </div>
        <ul class="nav-links">
            <li class="nav-item active" onclick="goHome()">Home</li>
            <li class="nav-item" onclick="showProgress()">Progress</li>
            <li class="nav-item" onclick="showSettings()">Settings</li>
        </ul>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Breadcrumb -->
            <div class="breadcrumb" id="breadcrumb">
                <span onclick="goHome()">Home</span>
            </div>

            <!-- Dynamic Views -->
            <div id="view-container">
                <!-- Views will be injected here -->
            </div>

            <div class="loader" id="loader"></div>
        </div>
    </main>

    <!-- AI Chat Box -->
    <div class="ai-fab" onclick="toggleChat()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />
        </svg>
    </div>

    <div class="ai-box glass" id="ai-box">
        <div class="chat-header">
            AI Doubt Assistant
            <span style="cursor:pointer" onclick="toggleChat()">×</span>
        </div>
        <div class="chat-messages" id="chat-messages">
            <div class="message ai-msg">Hello! I'm your AI study companion. Ask me anything about your syllabus!</div>
        </div>
        <div class="chat-input-area">
            <input type="text" class="chat-input" id="chat-input" placeholder="Ask a doubt..." onkeypress="handleChatKey(event)">
            <button class="send-btn" onclick="sendChat()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="22" y1="2" x2="11" y2="13" />
                    <polygon points="22 2 15 22 11 13 2 9 22 2" />
                </svg>
            </button>
        </div>
    </div>

    <!-- Quiz Modal -->
    <div class="modal-overlay" id="quiz-modal">
        <div class="quiz-modal glass">
            <h2 id="quiz-title">Topic Quiz</h2>
            <div id="quiz-content">
                <!-- Questions injected here -->
            </div>
            <button class="option-btn" style="background: var(--accent-color); color: black; text-align: center; margin-top: 1rem;" onclick="closeQuiz()">Close Quiz</button>
        </div>
    </div>

    <script>
        // State
        let currentClass = null;
        let currentSubject = null;
        let currentChapter = null;
        let currentTopic = null;
        let currentTopicName = null;
        let topicTimer = null;

        function clearTopicTimer() {
            if (topicTimer) {
                clearTimeout(topicTimer);
                topicTimer = null;
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadClasses();
        });

        // Navigation Logic
        async function loadClasses() {
            clearTopicTimer();
            showLoader(true);
            try {
                const res = await fetch('/api/classes');
                const classes = await res.json();
                
                const container = document.getElementById('view-container');
                let html = `
                    <div class="hero-section glass">
                        <div class="hero-content">
                            <h1 class="hero-title">Welcome to StudyBuddy</h1>
                            <p class="hero-subtitle">Your intelligent AI companion for mastering CBSE & JEE concepts. Start your learning journey today.</p>
                            <div class="hero-stats">
                                <div class="stat-item">
                                    <span class="stat-value">AI-Powered</span>
                                    <span class="stat-label">Personalized Learning</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">24/7</span>
                                    <span class="stat-label">Doubt Support</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-value">Smart</span>
                                    <span class="stat-label">Progress Tracking</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-header">
                        <h2 class="section-title">Select Your Class</h2>
                    </div>
                    <div class="grid">
                `;
                
                classes.forEach(item => {
                    html += `
                        <div class="card glass" onclick="loadSubjects('${item.id}')">
                            <div style="width: 50px; height: 50px; background: rgba(56, 189, 248, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--accent-color)" stroke-width="2">
                                    <path d="M22 10v6M2 10v6" />
                                    <path d="M20 2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h15z" />
                                </svg>
                            </div>
                            <h3>${item.name}</h3>
                            <p>Access comprehensive study materials, Q&A, and quizzes.</p>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;
                
                updateBreadcrumb([]);
            } catch (e) {
                console.error(e);
            }
            showLoader(false);
        }

        async function loadSubjects(classId) {
            clearTopicTimer();
            showLoader(true);
            currentClass = classId;
            try {
                const res = await fetch(`/api/subjects/${classId}`);
                const subjects = await res.json();
                
                const container = document.getElementById('view-container');
                let html = `
                    <div class="hero-section glass" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%);">
                        <div class="hero-content">
                            <h1 class="hero-title">Class ${classId}</h1>
                            <p class="hero-subtitle">Select a subject to start exploring chapters and topics.</p>
                        </div>
                    </div>
                    <div class="section-header">
                        <h2 class="section-title">Subjects</h2>
                    </div>
                    <div class="grid">
                `;
                
                subjects.forEach(item => {
                    html += `
                        <div class="card glass" onclick="loadChapters('${item.id}')">
                            <div style="width: 50px; height: 50px; background: rgba(16, 185, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10b981" stroke-width="2">
                                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" />
                                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" />
                                </svg>
                            </div>
                            <h3>${item.name}</h3>
                            <p>Explore chapters</p>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;

                updateBreadcrumb(['Class ' + classId]);
            } catch (e) {
                console.error(e);
            }
            showLoader(false);
        }

        async function loadChapters(subjectId) {
            clearTopicTimer();
            showLoader(true);
            currentSubject = subjectId;
            try {
                const res = await fetch(`/api/chapters/${currentClass}/${subjectId}`);
                const chapters = await res.json();
                
                const container = document.getElementById('view-container');
                let html = `
                    <div class="hero-section glass" style="background: linear-gradient(135deg, rgba(245, 158, 11, 0.2) 0%, rgba(217, 119, 6, 0.2) 100%);">
                        <div class="hero-content">
                            <h1 class="hero-title">${subjectId}</h1>
                            <p class="hero-subtitle">Class ${currentClass} • Select a chapter to view topics.</p>
                        </div>
                    </div>
                    <div class="section-header">
                        <h2 class="section-title">Chapters</h2>
                    </div>
                    <div class="grid">
                `;
                
                chapters.forEach(item => {
                    html += `
                        <div class="card glass" onclick="loadTopics('${item.id}')">
                            <div style="width: 50px; height: 50px; background: rgba(245, 158, 11, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f59e0b" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" />
                                    <polyline points="14 2 14 8 20 8" />
                                    <line x1="16" y1="13" x2="8" y2="13" />
                                    <line x1="16" y1="17" x2="8" y2="17" />
                                    <polyline points="10 9 9 9 8 9" />
                                </svg>
                            </div>
                            <h3>${item.name}</h3>
                            <p>View topics</p>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;

                updateBreadcrumb(['Class ' + currentClass, subjectId]);
            } catch (e) {
                console.error(e);
            }
            showLoader(false);
        }

        async function loadTopics(chapterId) {
            clearTopicTimer();
            showLoader(true);
            currentChapter = chapterId;
            try {
                const res = await fetch(`/api/topics/${currentClass}/${currentSubject}/${chapterId}`);
                const topics = await res.json();
                
                const container = document.getElementById('view-container');
                let html = `
                    <div class="hero-section glass" style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(219, 39, 119, 0.2) 100%);">
                        <div class="hero-content">
                            <h1 class="hero-title">${chapterId}</h1>
                            <p class="hero-subtitle">${currentSubject} • Select a topic to start learning.</p>
                        </div>
                    </div>
                    <div class="section-header">
                        <h2 class="section-title">Topics</h2>
                    </div>
                    <div class="grid">
                `;
                
                topics.forEach(item => {
                    html += `
                        <div class="card glass" onclick="loadContent('${item.id}', '${item.name.replace(/'/g, "\'")}')">
                            <div style="width: 50px; height: 50px; background: rgba(236, 72, 153, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#ec4899" stroke-width="2">
                                    <circle cx="12" cy="12" r="10" />
                                    <line x1="12" y1="16" x2="12" y2="12" />
                                    <line x1="12" y1="8" x2="12.01" y2="8" />
                                </svg>
                            </div>
                            <h3>${item.name}</h3>
                            <p>Start Learning</p>
                        </div>
                    `;
                });
                html += `</div>`;
                container.innerHTML = html;

                updateBreadcrumb(['Class ' + currentClass, currentSubject, chapterId]);
            } catch (e) {
                console.error(e);
            }
            showLoader(false);
        }

        async function loadContent(topicId, topicName) {
            clearTopicTimer();
            showLoader(true);
            currentTopic = topicId;
            currentTopicName = topicName;
            
            // Mark complete after 5 minutes (300,000 ms)
            topicTimer = setTimeout(() => {
                if (typeof markTopicComplete === 'function') {
                    markTopicComplete(topicId, topicName);
                }
            }, 300000);

            // Render Skeleton first
            const container = document.getElementById('view-container');
            container.innerHTML = `
                <div class="topic-container" style="display:block">
                    <h1>${topicName}</h1>
                    <div class="tabs">
                        <div class="tab active" onclick="switchTab('explanation')">Explanation</div>
                        <div class="tab" onclick="switchTab('board_qa')">Board Q&A</div>
                        <div class="tab" onclick="switchTab('jee_qa')">JEE Q&A</div>
                        <div class="tab" onclick="switchTab('notes')">Notes</div>
                    </div>
                    <button class="option-btn" style="width: auto; background: var(--accent-color); color: black; margin-bottom: 1rem;" onclick="startQuiz('${topicName}')">Take Quiz</button>
                    
                    <div id="content-explanation" class="content-section active">Loading AI Explanation...</div>
                    <div id="content-board_qa" class="content-section">Loading Board Q&A...</div>
                    <div id="content-jee_qa" class="content-section">Loading JEE Q&A...</div>
                    <div id="content-notes" class="content-section">Loading Notes...</div>
                </div>
            `;
            updateBreadcrumb(['Class ' + currentClass, currentSubject, currentChapter, topicName]);
            showLoader(false);

            // Fetch content for each section dynamically
            fetchAndRenderSection(topicName, 'explanation');
            fetchAndRenderSection(topicName, 'board_qa');
            fetchAndRenderSection(topicName, 'jee_qa');
            fetchAndRenderSection(topicName, 'notes');
        }

        async function fetchAndRenderSection(topicName, section) {
            try {
                const res = await fetch('/api/generate_content', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic_name: topicName, section: section })
                });
                const data = await res.json();
                const el = document.getElementById(`content-${section}`);
                if (data.content) {
                    el.innerHTML = parseMarkdown(data.content);
                    // Add download button if it's Q&A
                    if (section === 'board_qa' || section === 'jee_qa') {
                        const btn = document.createElement('button');
                        btn.className = 'option-btn';
                        btn.style.width = 'auto';
                        btn.style.marginTop = '1rem';
                        btn.style.background = 'var(--accent-color)';
                        btn.style.color = 'black';
                        btn.innerText = `Download ${section === 'board_qa' ? 'Board' : 'JEE'} Q&A`;
                        btn.onclick = () => downloadContent(`content-${section}`, `${topicName}_${section}.txt`);
                        el.prepend(btn);
                    }
                } else {
                    el.innerHTML = data.error ? `Error: ${data.error} ` : "Failed to load content.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById(`content-${section}`).innerHTML = "Error loading content. Please check backend logs.";
            }
        }

        function downloadContent(sectionId, filename) {
            const content = document.getElementById(sectionId).innerText;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Helper Functions
        function renderGrid(items, title, type) {
            const container = document.getElementById('view-container');
            let html = `<h1>${title}</h1><div class="grid">`;
            items.forEach(item => {
                let clickHandler = '';
                if (type === 'class') clickHandler = `loadSubjects('${item.id}')`;
                else if (type === 'subject') clickHandler = `loadChapters('${item.id}')`;
                else if (type === 'chapter') clickHandler = `loadTopics('${item.id}')`;
                else if (type === 'topic') clickHandler = `loadContent('${item.id}', '${item.name.replace(/'/g, "\'")}')`;

                html += `
            <div class="card glass" onclick="${clickHandler}">
                <h3>${item.name}</h3>
                <p>Click to explore</p>
            </div>
            `;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        function updateBreadcrumb(path) {
            const breadcrumb = document.getElementById('breadcrumb');
            let html = `<span onclick="goHome()">Home</span>`;
            path.forEach((p, index) => {
                html += ` > <span>${p}</span>`;
            });
            breadcrumb.innerHTML = html;
        }

        function goHome() {
            clearTopicTimer();
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item:first-child').classList.add('active');

            currentClass = null;
            currentSubject = null;
            currentChapter = null;
            currentTopic = null;
            loadClasses();
        }

        function showLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));

            event.target.classList.add('active');
            document.getElementById(`content-${tabName}`).classList.add('active');
        }

        function parseMarkdown(text) {
            return text
                .replace(/\*\*\[(.*?)\]\*\*/g, '<span class="year-tag">[$1]</span>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        // Chat Logic
        function toggleChat() {
            document.getElementById('ai-box').classList.toggle('open');
        }

        function handleChatKey(e) {
            if (e.key === 'Enter') sendChat();
        }

        async function sendChat() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;

            addMessage(msg, 'user');
            input.value = '';

            try {
                const context = currentTopic ? `Current Topic: ${currentTopic} ` : 'General Query';
                const res = await fetch('/api/ask_ai', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: msg, context: context })
                });
                if (!res.ok) throw new Error(`Server Error: ${res.status} `);
                const data = await res.json();
                if (data.error) throw new Error(data.error);
                addMessage(data.answer, 'ai');
            } catch (e) {
                console.error(e);
                addMessage(`Sorry, I encountered an error: ${e.message}. Please check if the backend is running.`, 'ai');
            }
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = `message ${sender}-msg`;
            div.innerHTML = parseMarkdown(text);
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Quiz Logic
        async function startQuiz(topicName) {
            currentTopicName = topicName;
            document.getElementById('quiz-modal').classList.add('open');
            const content = document.getElementById('quiz-content');
            content.innerHTML = '<div class="loader" style="display:block"></div>';

            try {
                const res = await fetch(`/api/quiz/${currentTopic}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic_name: topicName })
                });

                const questions = await res.json();
                renderQuiz(questions);
            } catch (e) {
                content.innerHTML = '<p>Error loading quiz.</p>';
            }
        }

        function renderQuiz(questions) {
            const content = document.getElementById('quiz-content');
            if (questions.error) {
                content.innerHTML = `<p>${questions.error}</p>`;
                return;
            }

            let html = '';
            questions.forEach((q, idx) => {
                html += `
            <div style="margin-bottom: 2rem;">
                <p><strong>Q${idx + 1}: ${q.question}</strong></p>
        ${
            q.options.map((opt, i) => `
            <button class="option-btn" onclick="checkAnswer(this, ${i}, ${q.correct_answer})">${opt}</button>
        `).join('')
        }
        <div class="explanation" style="display:none; margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.1); border-radius: 8px; border-left: 4px solid var(--accent-color);">
            <strong>Explanation:</strong> ${q.explanation || 'No explanation provided.'}
        </div>
    </div>
            `;
            });
            html += `
                <div style="margin-top: 2rem; text-align: center;">
                    <button class="option-btn" style="background: var(--accent-color); color: black; display: inline-block; width: auto; padding: 0.8rem 2rem;" onclick="finishQuiz(${questions.length})">
                        Finish Quiz
                    </button>
                </div>
            `;
            content.innerHTML = html;
        }

        function checkAnswer(btn, selected, correct) {
            const parent = btn.parentElement;
            const buttons = parent.querySelectorAll('.option-btn');
            buttons.forEach(b => b.disabled = true);

            if (selected === correct) {
                btn.classList.add('correct');
                btn.classList.add('user-correct');
            } else {
                btn.classList.add('wrong');
                buttons[correct].classList.add('correct');
            }
            
            // Show explanation
            const explanation = parent.querySelector('.explanation');
            if (explanation) explanation.style.display = 'block';
        }

        function finishQuiz(total) {
            const correct = document.querySelectorAll('.option-btn.user-correct').length;
            if (typeof recordQuizScore === 'function') {
                recordQuizScore(currentTopic, currentTopicName, correct, total);
            }
            closeQuiz();
        }

        function closeQuiz() {
            document.getElementById('quiz-modal').classList.remove('open');
        }
    </script>
    <script src="{{ url_for('static', filename='progress-settings.js') }}"></script>
</body>
</html>